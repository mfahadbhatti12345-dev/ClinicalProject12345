<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Drug Interaction Study Form</title>
  
  <!-- 1. Load React and ReactDOM -->
  <script src="https://unpkg.com/react@18/umd/react.development.js" crossorigin></script>
  <script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js" crossorigin></script>
  
  <!-- 2. Load Babel for JSX processing -->
  <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
  
  <!-- 3. Load Tailwind CSS for styling -->
  <script src="https://cdn.tailwindcss.com"></script>
  
  <!-- 4. Load FontAwesome for Icons -->
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

  <style>
    @media print {
      .no-print { display: none !important; }
      body { background: white; }
      .print-break-inside-avoid { break-inside: avoid; }
    }
  </style>
</head>
<body class="bg-gray-50 text-gray-800 font-sans">
  
  <div id="root"></div>

  <script type="text/babel">
    const { useState, useEffect } = React;

    // --- CONFIGURATION ---
    // GOOGLE KEY IS NOW REMOVED. IT WILL BE FETCHED FROM SUPABASE.
    const GOOGLE_API_KEY = ""; 
    
    // ⚠️ CRITICAL: PASTE YOUR SUPABASE CREDENTIALS HERE ⚠️
    // Go to Supabase Dashboard -> Settings -> API to find these.
    const SUPABASE_URL = "https://rkfqtbjfknydcydlkauy.supabase.co"; 
    const SUPABASE_KEY = "sb_publishable_MX87w02lC19Lpxhhy3BBTg_hx4f4oxJ"; 

    function App() {
      // --- AUTH STATE ---
      const [isLoggedIn, setIsLoggedIn] = useState(false);
      const [passwordInput, setPasswordInput] = useState('');
      const [rememberMe, setRememberMe] = useState(false);
      const [authError, setAuthError] = useState('');

      // --- APP STATE ---
      const [loading, setLoading] = useState(false);
      const [error, setError] = useState('');
      const [saveStatus, setSaveStatus] = useState(''); 
      const [geminiKey, setGeminiKey] = useState(''); // Stores the fetched key
      
      const [view, setView] = useState('form');
      const [savedRecords, setSavedRecords] = useState([]);
      const [loadingRecords, setLoadingRecords] = useState(false);
      
      const [editingId, setEditingId] = useState(null);
      const [printRecord, setPrintRecord] = useState(null);

      // --- Form State ---
      const initialFormState = {
        patientId: '',
        age: '',
        gender: 'Male',
        ward: 'Medicine',
        wardOther: '',
        dateOfAdmission: '',
        primaryDiagnosis: '',
        conditions: {
          hypertension: false,
          diabetes: false,
          renalDisease: false,
          liverDisease: false,
          cvd: false,
          other: false
        },
        conditionsOther: '',
        comorbidCount: 'None',
        totalDrugs: '2-4',
        antibioticsPrescribed: 'No',
        medications: [
          { name: '', dose: '', frequency: '' },
          { name: '', dose: '', frequency: '' },
          { name: '', dose: '', frequency: '' }
        ],
        interactionIdentified: 'No',
        interactionCount: '',
        interactionType: [], 
        interactionSeverity: '',
        interactionOnset: 'Unknown',
        drugCombination: '',
        clinicalEffect: 'No',
        clinicalObservations: [],
        adverseOutcome: [],
        adverseOutcomeOther: '',
        actionTaken: 'No',
        actionTakenType: [],
        pharmacistInvolved: 'No',
        hospitalStayAffected: 'No',
        stayLength: '',
        finalOutcome: '',
        aiDetailedExplanation: '',
        aiFollowUpQueries: [],
        aiAlternatives: []
      };

      const [formData, setFormData] = useState(initialFormState);

      // --- AUTH EFFECT ---
      useEffect(() => {
        const savedAuth = localStorage.getItem('drug_study_app_auth');
        if (savedAuth === 'valid') {
          setIsLoggedIn(true);
        }
      }, []);

      // --- AUTH HANDLERS ---
      const handleLogin = (e) => {
        e.preventDefault();
        if (passwordInput === '12345') {
          setIsLoggedIn(true);
          setAuthError('');
          if (rememberMe) {
            localStorage.setItem('drug_study_app_auth', 'valid');
          }
        } else {
          setAuthError('Invalid password. Please try again.');
        }
      };

      const handleLogout = () => {
        setIsLoggedIn(false);
        localStorage.removeItem('drug_study_app_auth');
        setPasswordInput('');
        setRememberMe(false);
        setView('form');
      };

      // --- FORM HANDLERS ---
      const handleInputChange = (section, field, value) => {
        setFormData(prev => ({ ...prev, [field]: value }));
      };

      const handleConditionToggle = (condition) => {
        setFormData(prev => ({
          ...prev,
          conditions: { ...prev.conditions, [condition]: !prev.conditions[condition] }
        }));
      };

      const handleMedicationChange = (index, field, value) => {
        const newMeds = [...formData.medications];
        newMeds[index][field] = value;
        setFormData(prev => ({ ...prev, medications: newMeds }));
      };

      const addMedicationRow = () => {
        setFormData(prev => ({
          ...prev,
          medications: [...prev.medications, { name: '', dose: '', frequency: '' }]
        }));
      };

      const removeMedicationRow = (index) => {
        const newMeds = formData.medications.filter((_, i) => i !== index);
        setFormData(prev => ({ ...prev, medications: newMeds }));
      };

      const handleCheckboxGroup = (field, value) => {
        setFormData(prev => {
          const currentList = prev[field] || [];
          if (currentList.includes(value)) {
            return { ...prev, [field]: currentList.filter(item => item !== value) };
          } else {
            return { ...prev, [field]: [...currentList, value] };
          }
        });
      };

      const resetForm = () => {
        setFormData(initialFormState);
        setEditingId(null);
        setView('form');
      };

      // --- HELPER: FETCH KEY FROM SUPABASE ---
      const fetchGeminiKey = async () => {
        if (geminiKey) return geminiKey;

        // Check if user has updated placeholders
        if (SUPABASE_URL.includes("YOUR_PROJECT_ID")) {
           throw new Error("Supabase Configuration Missing. Please open the HTML code and update SUPABASE_URL and SUPABASE_KEY.");
        }

        try {
          const response = await fetch(`${SUPABASE_URL}/rest/v1/system_settings?setting_name=eq.google_gemini_key&select=setting_value`, {
            method: 'GET',
            headers: {
              'apikey': SUPABASE_KEY,
              'Authorization': `Bearer ${SUPABASE_KEY}`
            }
          });

          if (!response.ok) {
             if(response.status === 404) throw new Error("Database Table Not Found. Did you run the SQL script?");
             throw new Error(`Database Error (${response.status}). Check your URL and Key.`);
          }
          
          const data = await response.json();
          if (data && data.length > 0) {
            const key = data[0].setting_value;
            setGeminiKey(key);
            return key;
          } else {
            throw new Error("API Key not found. Please insert 'google_gemini_key' into the 'system_settings' table.");
          }
        } catch (err) {
          throw new Error("Setup Error: " + err.message);
        }
      };

      // --- SUPABASE DATA HANDLERS ---
      const saveToSupabase = async () => {
        if (SUPABASE_URL.includes("YOUR_PROJECT_ID")) {
          setError("Please configure SUPABASE_URL and SUPABASE_KEY in the code first.");
          return;
        }
        if (!formData.patientId) {
          setError("Patient ID is required to save.");
          return;
        }

        setSaveStatus('saving');
        setError('');

        try {
          const url = editingId 
            ? `${SUPABASE_URL}/rest/v1/drug_studies?id=eq.${editingId}`
            : `${SUPABASE_URL}/rest/v1/drug_studies`;
          
          const method = editingId ? 'PATCH' : 'POST';

          const response = await fetch(url, {
            method: method,
            headers: {
              'apikey': SUPABASE_KEY,
              'Authorization': `Bearer ${SUPABASE_KEY}`,
              'Content-Type': 'application/json',
              'Prefer': 'return=minimal'
            },
            body: JSON.stringify({
              patient_id: formData.patientId,
              study_data: formData
            })
          });

          if (!response.ok) throw new Error(`Supabase Error: ${response.statusText}`);

          setSaveStatus('success');
          setTimeout(() => setSaveStatus(''), 3000);
          
        } catch (err) {
          setSaveStatus('error');
          setError("Save Failed: " + err.message);
        }
      };

      const deleteRecord = async (id) => {
        if (!window.confirm("Are you sure you want to delete this record? This cannot be undone.")) return;

        try {
          const response = await fetch(`${SUPABASE_URL}/rest/v1/drug_studies?id=eq.${id}`, {
            method: 'DELETE',
            headers: {
              'apikey': SUPABASE_KEY,
              'Authorization': `Bearer ${SUPABASE_KEY}`
            }
          });

          if (!response.ok) throw new Error(`Supabase Error: ${response.statusText}`);

          setSavedRecords(prev => prev.filter(r => r.id !== id));
          setSaveStatus('deleted');
          setTimeout(() => setSaveStatus(''), 3000);

        } catch (err) {
          setError("Delete Failed: " + err.message);
        }
      };

      const fetchRecords = async () => {
        if (SUPABASE_URL.includes("YOUR_PROJECT_ID")) return;

        setLoadingRecords(true);
        try {
          const response = await fetch(`${SUPABASE_URL}/rest/v1/drug_studies?select=*&order=created_at.desc`, {
            method: 'GET',
            headers: {
              'apikey': SUPABASE_KEY,
              'Authorization': `Bearer ${SUPABASE_KEY}`
            }
          });

          if (!response.ok) throw new Error(`Supabase Error: ${response.statusText}`);

          const data = await response.json();
          setSavedRecords(data);
        } catch (err) {
          setError("Fetch Failed: " + err.message);
        } finally {
          setLoadingRecords(false);
        }
      };

      const loadRecordForEdit = (record) => {
        setFormData(record.study_data);
        setEditingId(record.id);
        setView('form');
      };

      // --- PRINT LOGIC ---
      const handlePrint = () => {
        window.print();
      };

      const prepareSinglePrint = (record) => {
        setPrintRecord(record);
        setView('print_single');
        setTimeout(() => window.print(), 500);
      };

      const prepareAllPrint = () => {
        setView('print_all');
        setTimeout(() => window.print(), 500);
      };

      // --- AI ANALYSIS LOGIC ---
      const analyzeInteractions = async () => {
        // 1. Get the Key dynamically from Supabase
        setLoading(true);
        setError('');
        let currentKey = '';
        
        try {
          currentKey = await fetchGeminiKey();
        } catch (err) {
          setLoading(false);
          setError(err.message);
          return;
        }

        const activeMeds = formData.medications
          .filter(m => m.name.trim() !== "")
          .map(m => `${m.name} (Dose: ${m.dose}, Freq: ${m.frequency})`);
        
        if (activeMeds.length < 2) {
          setLoading(false);
          setError("Please enter at least 2 medications.");
          return;
        }

        const activeConditions = Object.entries(formData.conditions)
          .filter(([_, active]) => active)
          .map(([name, _]) => name === 'other' ? `Other: ${formData.conditionsOther}` : name);

        const prompt = `
          Act as a clinical pharmacist. Analyze patient data:
          PATIENT: Age ${formData.age}, ${formData.gender}, Dx: ${formData.primaryDiagnosis}, Comorbidities: ${activeConditions.join(', ') || 'None'}
          MEDS: ${activeMeds.join('\n')}
          
          TASK:
          1. Identify DDIs (Drug-Drug Interactions).
          2. Classify severity STRICTLY (Major/Moderate/Minor).
          3. Suggest SAFER THERAPEUTIC ALTERNATIVES.
          4. For each alternative, provide the CALCULATION LOGIC for the dose/interval. 
             - If renal adjustment is needed, show the formula (e.g., Cockcroft-Gault estimate based on age/gender).
             - If hepatic adjustment, cite the guideline logic.
             - Provide a specific CALL TO ACTION for the pharmacist.
          
          RETURN JSON:
          {
            "interactionIdentified": "Yes/No",
            "interactionCount": "1/2-3/>3",
            "interactionType": ["Pharmacokinetic", "Pharmacodynamic"], 
            "severity": "Minor/Moderate/Major",
            "onset": "Rapid/Delayed",
            "drugCombination": "Drug A + Drug B",
            "clinicalEffectLikely": "Yes/No",
            "potentialObservations": ["Adverse drug reaction", "Abnormal laboratory value"],
            "detailedExplanation": "Clinical mechanism...",
            "followUpQueries": ["Check 1...", "Check 2..."],
            "alternatives": [
              { 
                "drug": "Alternative Name", 
                "dose": "Dose", 
                "frequency": "Freq", 
                "reason": "Why it is safer",
                "calculationBasis": "Detailed explanation of how dose was derived (e.g., 'Reduced by 50% due to estimated CrCl < 30ml/min').",
                "formulaUsed": "The formula or rule (e.g., 'Cockcroft-Gault: (140-Age) * Wt...').",
                "callToAction": "Specific intervention (e.g., 'Monitor K+ levels every 48h')."
              }
            ]
          }
        `;

        try {
          // Use the fetched 'currentKey' here
          const response = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${currentKey}`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ contents: [{ parts: [{ text: prompt }] }] })
          });

          const data = await response.json();
          if (data.error) throw new Error(data.error.message);

          const textResponse = data.candidates[0].content.parts[0].text;
          const cleanJson = textResponse.replace(/```json/g, '').replace(/```/g, '').trim();
          const analysis = JSON.parse(cleanJson);

          setFormData(prev => ({
            ...prev,
            interactionIdentified: analysis.interactionIdentified,
            interactionCount: analysis.interactionCount,
            interactionType: analysis.interactionType || [],
            interactionSeverity: analysis.severity,
            interactionOnset: analysis.onset,
            drugCombination: analysis.drugCombination,
            clinicalEffect: analysis.clinicalEffectLikely,
            clinicalObservations: analysis.potentialObservations || [],
            aiDetailedExplanation: analysis.detailedExplanation,
            aiFollowUpQueries: analysis.followUpQueries || [],
            aiAlternatives: analysis.alternatives || []
          }));

        } catch (err) {
          setError("AI Analysis Failed: " + err.message);
        } finally {
          setLoading(false);
        }
      };

      // --- VIEW RENDERING HELPERS ---
      const getSeverityColorStyles = (severity) => {
        switch (severity) {
          case 'Major': return 'bg-red-50 border-red-500 text-red-900 border-l-4';
          case 'Moderate': return 'bg-orange-50 border-orange-500 text-orange-900 border-l-4';
          case 'Minor': return 'bg-yellow-50 border-yellow-500 text-yellow-900 border-l-4';
          default: return 'bg-gray-50 border-gray-200 text-gray-900';
        }
      };

      const getSeverityBadge = (severity) => {
        switch (severity) {
          case 'Major': return <span className="bg-red-600 text-white px-3 py-1 rounded-full text-xs font-bold uppercase tracking-wider">Major Risk</span>;
          case 'Moderate': return <span className="bg-orange-500 text-white px-3 py-1 rounded-full text-xs font-bold uppercase tracking-wider">Moderate Risk</span>;
          case 'Minor': return <span className="bg-yellow-500 text-white px-3 py-1 rounded-full text-xs font-bold uppercase tracking-wider">Minor Risk</span>;
          default: return null;
        }
      };

      // --- LOGIN VIEW ---
      if (!isLoggedIn) {
        return (
          <div className="min-h-screen bg-gray-100 flex items-center justify-center p-4 font-sans">
            <div className="bg-white p-8 rounded-lg shadow-xl w-full max-w-sm border border-gray-200">
              <div className="text-center mb-8">
                <div className="inline-flex items-center justify-center w-16 h-16 bg-blue-100 rounded-full mb-4">
                   <i className="fas fa-user-shield text-3xl text-blue-600"></i>
                </div>
                <h1 className="text-2xl font-bold text-gray-800">Secure Access</h1>
                <p className="text-gray-500 text-sm mt-1">Drug Interaction Study</p>
              </div>
              
              <form onSubmit={handleLogin} className="space-y-6">
                <div>
                  <label className="block text-sm font-semibold text-gray-700 mb-2">Access Password</label>
                  <div className="relative">
                    <div className="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none">
                      <i className="fas fa-lock text-gray-400"></i>
                    </div>
                    <input 
                      type="password" 
                      className="w-full pl-10 p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 outline-none transition"
                      placeholder="Enter password"
                      value={passwordInput}
                      onChange={(e) => setPasswordInput(e.target.value)}
                    />
                  </div>
                </div>
                
                <div className="flex items-center">
                  <input 
                    id="remember_me" 
                    type="checkbox" 
                    className="h-4 w-4 text-blue-600 focus:ring-blue-500 border-gray-300 rounded cursor-pointer"
                    checked={rememberMe}
                    onChange={(e) => setRememberMe(e.target.checked)}
                  />
                  <label htmlFor="remember_me" className="ml-2 block text-sm text-gray-900 cursor-pointer">
                    Remember me
                  </label>
                </div>

                {authError && (
                  <div className="text-red-600 text-sm flex items-center gap-2 bg-red-50 p-3 rounded-lg border border-red-100 animate-pulse">
                    <i className="fas fa-exclamation-circle"></i> {authError}
                  </div>
                )}

                <button 
                  type="submit"
                  className="w-full flex justify-center py-3 px-4 border border-transparent rounded-lg shadow-md text-sm font-bold text-white bg-blue-700 hover:bg-blue-800 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500 transition-colors"
                >
                  Login System
                </button>
              </form>
            </div>
          </div>
        );
      }

      // --- PRINT VIEWS (Hidden unless printing) ---
      if (view === 'print_single' && printRecord) {
        const d = printRecord.study_data;
        return (
          <div className="p-8 bg-white font-serif max-w-4xl mx-auto">
            <div className="no-print mb-4 flex gap-4">
               <button onClick={() => setView('list')} className="flex items-center gap-2 bg-gray-200 px-4 py-2 rounded">
                 <i className="fas fa-arrow-left"></i> Back
               </button>
               <button onClick={handlePrint} className="flex items-center gap-2 bg-blue-600 text-white px-4 py-2 rounded">
                 <i className="fas fa-print"></i> Print / Save PDF
               </button>
            </div>

            <div className="border-b-2 border-black pb-4 mb-6 text-center">
              <h1 className="text-2xl font-bold uppercase tracking-wider">Clinical Pharmacist Intervention Report</h1>
              <p className="text-sm text-gray-600">Drug-Drug Interaction Study • Confidential</p>
            </div>

            <div className="grid grid-cols-2 gap-6 mb-6">
              <div>
                 <h3 className="font-bold border-b border-gray-300 mb-2">Patient Demographics</h3>
                 <p><span className="font-semibold">ID:</span> {d.patientId}</p>
                 <p><span className="font-semibold">Age/Gender:</span> {d.age} / {d.gender}</p>
                 <p><span className="font-semibold">Ward:</span> {d.ward} {d.wardOther && `(${d.wardOther})`}</p>
                 <p><span className="font-semibold">Diagnosis:</span> {d.primaryDiagnosis}</p>
              </div>
              <div>
                 <h3 className="font-bold border-b border-gray-300 mb-2">Clinical Profile</h3>
                 <p><span className="font-semibold">Comorbidities:</span> {Object.entries(d.conditions).filter(([_,v])=>v).map(([k])=>k).join(', ')}</p>
                 <p><span className="font-semibold">Total Drugs:</span> {d.totalDrugs}</p>
              </div>
            </div>

            <div className="mb-6">
               <h3 className="font-bold border-b border-gray-300 mb-2">Medication List</h3>
               <table className="w-full text-left text-sm">
                 <thead><tr className="bg-gray-100"><th>Drug Name</th><th>Dose</th><th>Frequency</th></tr></thead>
                 <tbody>
                   {d.medications.map((m, i) => (
                     <tr key={i} className="border-b">
                       <td className="py-1">{m.name}</td><td>{m.dose}</td><td>{m.frequency}</td>
                     </tr>
                   ))}
                 </tbody>
               </table>
            </div>

            <div className={`mb-6 p-4 border rounded ${d.interactionIdentified === 'Yes' ? 'border-red-300 bg-red-50' : 'border-green-300 bg-green-50'}`}>
               <h3 className="font-bold mb-2">Interaction Analysis</h3>
               <p><span className="font-semibold">Identified:</span> {d.interactionIdentified}</p>
               {d.interactionIdentified === 'Yes' && (
                 <>
                   <p className="flex items-center gap-2 mt-2"><span className="font-semibold">Severity:</span> {getSeverityBadge(d.interactionSeverity)}</p>
                   <p className="mt-2"><span className="font-semibold">Combination:</span> {d.drugCombination}</p>
                   <p><span className="font-semibold">Mechanism:</span> {d.aiDetailedExplanation}</p>
                   <div className="mt-2">
                     <span className="font-semibold">Recommendations/Checks:</span>
                     <ul className="list-disc ml-5 text-sm">
                       {d.aiFollowUpQueries.map((q,i)=><li key={i}>{q}</li>)}
                     </ul>
                   </div>
                 </>
               )}
            </div>

            {d.aiAlternatives && d.aiAlternatives.length > 0 && (
              <div className="mb-6 p-4 border border-green-300 bg-green-50 rounded print-break-inside-avoid">
                <h3 className="font-bold mb-4 text-green-800 border-b border-green-200 pb-2"><i className="fas fa-check-circle"></i> Recommended Therapeutic Alternatives & Calculations</h3>
                <div className="space-y-4">
                  {d.aiAlternatives.map((alt, i) => (
                    <div key={i} className="border border-green-200 rounded p-3 bg-white">
                      <div className="flex justify-between font-bold text-green-900 mb-2">
                        <span>{alt.drug}</span>
                        <span>{alt.dose} ({alt.frequency})</span>
                      </div>
                      <div className="text-sm space-y-2">
                        <p><span className="font-semibold text-gray-700">Reason:</span> {alt.reason}</p>
                        <p><span className="font-semibold text-gray-700">Calculation Logic:</span> {alt.calculationBasis || 'Standard dosing applied.'}</p>
                        {alt.formulaUsed && (
                          <div className="bg-gray-100 p-2 rounded font-mono text-xs text-gray-700">
                            <strong>Formula:</strong> {alt.formulaUsed}
                          </div>
                        )}
                        <p className="text-blue-700 font-semibold bg-blue-50 p-2 rounded mt-2">
                          <i className="fas fa-exclamation-circle"></i> Action: {alt.callToAction || 'Monitor efficacy.'}
                        </p>
                      </div>
                    </div>
                  ))}
                </div>
              </div>
            )}

            <div className="text-xs text-gray-500 text-center mt-12 border-t pt-2">
              Generated via AI Drug Interaction Tool • Verified by: ________________________
            </div>
          </div>
        );
      }

      if (view === 'print_all') {
        return (
          <div className="p-4 bg-white font-sans text-xs">
             <div className="no-print mb-4 flex gap-4">
               <button onClick={() => setView('list')} className="flex items-center gap-2 bg-gray-200 px-4 py-2 rounded">
                 <i className="fas fa-arrow-left"></i> Back
               </button>
               <button onClick={handlePrint} className="flex items-center gap-2 bg-blue-600 text-white px-4 py-2 rounded">
                 <i className="fas fa-print"></i> Print / Save PDF
               </button>
            </div>
            <h1 className="text-xl font-bold mb-4">Patient Study Register</h1>
            <table className="w-full text-left border-collapse border border-gray-300">
              <thead>
                <tr className="bg-gray-100">
                  <th className="border p-2">ID</th>
                  <th className="border p-2">Age/Sex</th>
                  <th className="border p-2">Diagnosis</th>
                  <th className="border p-2">Drugs</th>
                  <th className="border p-2">Interaction</th>
                  <th className="border p-2">Severity</th>
                  <th className="border p-2">Outcome</th>
                </tr>
              </thead>
              <tbody>
                {savedRecords.map(r => {
                  const d = r.study_data;
                  return (
                    <tr key={r.id}>
                      <td className="border p-2">{d.patientId}</td>
                      <td className="border p-2">{d.age}/{d.gender?.[0]}</td>
                      <td className="border p-2">{d.primaryDiagnosis}</td>
                      <td className="border p-2">{d.medications.length}</td>
                      <td className="border p-2">{d.interactionIdentified}</td>
                      <td className="border p-2">{d.interactionSeverity}</td>
                      <td className="border p-2">{d.finalOutcome}</td>
                    </tr>
                  )
                })}
              </tbody>
            </table>
          </div>
        );
      }

      // --- RENDER: LIST VIEW ---
      if (view === 'list') {
        return (
          <div className="min-h-screen bg-gray-50 text-gray-800 font-sans">
            <header className="bg-blue-800 text-white p-4 shadow-md sticky top-0 z-20 no-print">
              <div className="max-w-6xl mx-auto flex justify-between items-center">
                 <div className="flex items-center gap-2">
                    <i className="fas fa-database text-xl"></i>
                    <h1 className="text-xl font-bold">Saved Study Records</h1>
                 </div>
                 <div className="flex gap-2">
                   <button 
                     onClick={prepareAllPrint}
                     className="bg-white/10 hover:bg-white/20 px-4 py-2 rounded flex items-center gap-2 text-sm font-semibold transition-colors"
                   >
                     <i className="fas fa-print"></i> Print Report (All)
                   </button>
                   <button 
                     onClick={() => { setEditingId(null); setView('form'); }}
                     className="bg-white text-blue-900 hover:bg-gray-100 px-4 py-2 rounded flex items-center gap-2 text-sm font-bold transition-colors"
                   >
                     <i className="fas fa-plus"></i> New Record
                   </button>
                   <button 
                    onClick={handleLogout}
                    className="bg-red-600/90 hover:bg-red-500 text-white px-3 py-2 rounded text-sm font-semibold flex items-center gap-2 ml-2"
                    title="Logout"
                   >
                     <i className="fas fa-sign-out-alt"></i> Logout
                   </button>
                 </div>
              </div>
            </header>

            <div className="max-w-6xl mx-auto p-4">
               {saveStatus === 'deleted' && (
                 <div className="bg-red-100 text-red-800 p-3 mb-4 rounded flex items-center gap-2">
                   <i className="fas fa-trash"></i> Record deleted successfully.
                 </div>
               )}

               {loadingRecords ? (
                 <div className="flex justify-center p-12"><i className="fas fa-spinner fa-spin text-3xl text-blue-600"></i></div>
               ) : savedRecords.length === 0 ? (
                 <div className="text-center p-12 bg-white rounded-lg border border-dashed border-gray-300">
                    <i className="fas fa-database text-4xl text-gray-300 mx-auto mb-4 block"></i>
                    <p className="text-gray-500">No records found. Create a new record to get started.</p>
                 </div>
               ) : (
                 <div className="bg-white shadow rounded-lg overflow-hidden">
                    <div className="overflow-x-auto">
                    <table className="w-full text-left border-collapse">
                      <thead className="bg-gray-100 border-b">
                        <tr>
                          <th className="p-4 font-semibold text-sm text-gray-600">Patient ID</th>
                          <th className="p-4 font-semibold text-sm text-gray-600">Diagnosis</th>
                          <th className="p-4 font-semibold text-sm text-gray-600">Interaction?</th>
                          <th className="p-4 font-semibold text-sm text-gray-600">Severity</th>
                          <th className="p-4 font-semibold text-sm text-gray-600 text-right">Actions</th>
                        </tr>
                      </thead>
                      <tbody className="divide-y divide-gray-200">
                        {savedRecords.map(record => {
                          const data = record.study_data;
                          return (
                            <tr key={record.id} className="hover:bg-gray-50 transition-colors group">
                              <td className="p-4 font-mono text-sm font-medium text-blue-600">{data.patientId || 'N/A'}</td>
                              <td className="p-4 text-sm text-gray-700">{data.primaryDiagnosis || '-'}</td>
                              <td className="p-4 text-sm">
                                {data.interactionIdentified === 'Yes' ? 
                                  <span className="inline-flex items-center gap-1 text-red-600 bg-red-50 px-2 py-1 rounded text-xs font-bold">
                                    <i className="fas fa-exclamation-triangle"></i> Yes
                                  </span> : 
                                  <span className="text-green-600 bg-green-50 px-2 py-1 rounded text-xs font-bold">No</span>
                                }
                              </td>
                              <td className="p-4 text-sm">
                                {data.interactionSeverity ? getSeverityBadge(data.interactionSeverity) : '-'}
                              </td>
                              <td className="p-4 text-right">
                                <div className="flex justify-end gap-2">
                                  <button 
                                    onClick={() => prepareSinglePrint(record)}
                                    className="p-2 text-gray-500 hover:text-blue-600 hover:bg-blue-50 rounded"
                                    title="Print Single Record"
                                  >
                                    <i className="fas fa-print"></i>
                                  </button>
                                  <button 
                                    onClick={() => loadRecordForEdit(record)}
                                    className="p-2 text-gray-500 hover:text-green-600 hover:bg-green-50 rounded"
                                    title="Edit Record"
                                  >
                                    <i className="fas fa-edit"></i>
                                  </button>
                                  <button 
                                    onClick={() => deleteRecord(record.id)}
                                    className="p-2 text-gray-500 hover:text-red-600 hover:bg-red-50 rounded"
                                    title="Delete Record"
                                  >
                                    <i className="fas fa-trash"></i>
                                  </button>
                                </div>
                              </td>
                            </tr>
                          );
                        })}
                      </tbody>
                    </table>
                    </div>
                 </div>
               )}
            </div>
          </div>
        );
      }

      // --- RENDER: FORM VIEW ---
      return (
        <div className="min-h-screen bg-gray-50 text-gray-800 font-sans pb-12">
          
          {/* Header */}
          <header className={`bg-blue-700 text-white p-6 shadow-md ${editingId ? 'bg-indigo-800' : ''}`}>
            <div className="max-w-4xl mx-auto flex flex-col md:flex-row justify-between items-center gap-4">
              <div>
                <h1 className="text-2xl font-bold flex items-center gap-2">
                  <i className="fas fa-heartbeat text-2xl"></i>
                  {editingId ? 'Editing Record' : 'Drug Interaction Study'}
                </h1>
                <p className="text-blue-100 mt-1 opacity-90 text-sm">
                  {editingId ? `Updating Patient ID: ${formData.patientId}` : 'Digital Data Collection Form'}
                </p>
              </div>
              <div className="flex gap-2">
                 {editingId && (
                   <button 
                    onClick={resetForm}
                    className="bg-white/20 hover:bg-white/30 px-4 py-2 rounded text-sm font-semibold"
                   >
                     Cancel Edit
                   </button>
                 )}
                 <button 
                  onClick={() => { setView('list'); fetchRecords(); }}
                  className="bg-white text-blue-900 hover:bg-gray-100 px-4 py-2 rounded-lg font-bold flex items-center gap-2 shadow transition-all"
                >
                  <i className="fas fa-database"></i> View Saved Records
                </button>
                <button 
                  onClick={handleLogout}
                  className="bg-red-600/90 hover:bg-red-500 text-white px-3 py-2 rounded text-sm font-semibold flex items-center gap-2 ml-2"
                  title="Logout"
                 >
                   <i className="fas fa-sign-out-alt"></i> Logout
                 </button>
              </div>
            </div>
          </header>

          <div className="max-w-4xl mx-auto p-4 space-y-8">

            {/* --- SECTION A: PATIENT INFO --- */}
            <section className="bg-white p-6 rounded-lg shadow-sm border border-gray-200">
              <h2 className="text-xl font-bold text-blue-800 mb-4 border-b pb-2">SECTION A: Patient Information</h2>
              
              <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
                <div>
                  <label className="block text-sm font-semibold text-gray-600 mb-1">1. Patient ID Code</label>
                  <input 
                    type="text" 
                    className="w-full p-2 border border-gray-300 rounded focus:ring-2 focus:ring-blue-500 outline-none"
                    value={formData.patientId}
                    onChange={(e) => handleInputChange('A', 'patientId', e.target.value)}
                  />
                </div>
                
                <div className="flex gap-4">
                  <div className="w-1/2">
                    <label className="block text-sm font-semibold text-gray-600 mb-1">2. Age (years)</label>
                    <input 
                      type="number" 
                      className="w-full p-2 border border-gray-300 rounded focus:ring-2 focus:ring-blue-500 outline-none"
                      value={formData.age}
                      onChange={(e) => handleInputChange('A', 'age', e.target.value)}
                    />
                  </div>
                  <div className="w-1/2">
                    <label className="block text-sm font-semibold text-gray-600 mb-1">3. Gender</label>
                    <select 
                      className="w-full p-2 border border-gray-300 rounded focus:ring-2 focus:ring-blue-500 outline-none"
                      value={formData.gender}
                      onChange={(e) => handleInputChange('A', 'gender', e.target.value)}
                    >
                      <option>Male</option>
                      <option>Female</option>
                    </select>
                  </div>
                </div>

                <div>
                  <label className="block text-sm font-semibold text-gray-600 mb-1">4. Hospital Ward</label>
                  <select 
                    className="w-full p-2 border border-gray-300 rounded focus:ring-2 focus:ring-blue-500 outline-none"
                    value={formData.ward}
                    onChange={(e) => handleInputChange('A', 'ward', e.target.value)}
                  >
                    <option>Medicine</option>
                    <option>ICU</option>
                    <option>Surgery</option>
                    <option>Others</option>
                  </select>
                  {formData.ward === 'Others' && (
                    <input 
                      type="text"
                      placeholder="Specify ward"
                      className="mt-2 w-full p-2 border border-gray-300 rounded"
                      value={formData.wardOther}
                      onChange={(e) => handleInputChange('A', 'wardOther', e.target.value)}
                    />
                  )}
                </div>

                <div>
                  <label className="block text-sm font-semibold text-gray-600 mb-1">5. Date of Admission</label>
                  <input 
                    type="date" 
                    className="w-full p-2 border border-gray-300 rounded focus:ring-2 focus:ring-blue-500 outline-none"
                    value={formData.dateOfAdmission}
                    onChange={(e) => handleInputChange('A', 'dateOfAdmission', e.target.value)}
                  />
                </div>
                
                <div className="md:col-span-2">
                  <label className="block text-sm font-semibold text-gray-600 mb-1">6. Primary Diagnosis</label>
                  <input 
                    type="text" 
                    placeholder="e.g. Pneumonia, CHF..."
                    className="w-full p-2 border border-gray-300 rounded focus:ring-2 focus:ring-blue-500 outline-none"
                    value={formData.primaryDiagnosis}
                    onChange={(e) => handleInputChange('A', 'primaryDiagnosis', e.target.value)}
                  />
                </div>
              </div>
            </section>

            {/* --- SECTION B: CLINICAL PROFILE --- */}
            <section className="bg-white p-6 rounded-lg shadow-sm border border-gray-200">
              <h2 className="text-xl font-bold text-blue-800 mb-4 border-b pb-2">SECTION B: Clinical Profile</h2>
              
              <div className="mb-4">
                <label className="block text-sm font-semibold text-gray-600 mb-2">7. Conditions (Tick all that apply)</label>
                <div className="grid grid-cols-2 md:grid-cols-3 gap-2">
                  {['Hypertension', 'Diabetes', 'Renal disease', 'Liver disease', 'Cardiovascular disease', 'Other'].map(cond => {
                    const key = cond === 'Renal disease' ? 'renalDisease' : 
                                cond === 'Liver disease' ? 'liverDisease' : 
                                cond === 'Cardiovascular disease' ? 'cvd' : 
                                cond.toLowerCase();
                    return (
                      <div key={cond}>
                        <label className="flex items-center space-x-2 cursor-pointer hover:bg-gray-50 p-2 rounded">
                          <input 
                            type="checkbox" 
                            className="rounded text-blue-600 focus:ring-blue-500"
                            checked={formData.conditions[key]}
                            onChange={() => handleConditionToggle(key)}
                          />
                          <span>{cond}</span>
                        </label>
                        {/* Render input box immediately if "Other" is checked */}
                        {cond === 'Other' && formData.conditions.other && (
                          <div className="ml-6 mt-1 mb-2">
                            <input 
                              type="text" 
                              placeholder="Please specify condition..."
                              className="w-full p-1 text-sm border-b-2 border-blue-200 focus:border-blue-500 outline-none bg-blue-50"
                              value={formData.conditionsOther}
                              onChange={(e) => handleInputChange('B', 'conditionsOther', e.target.value)}
                              autoFocus
                            />
                          </div>
                        )}
                      </div>
                    );
                  })}
                </div>
              </div>

              <div>
                 <label className="block text-sm font-semibold text-gray-600 mb-2">8. Number of comorbid conditions</label>
                 <div className="flex gap-4">
                   {['None', '1-2', '≥3'].map(opt => (
                     <label key={opt} className="flex items-center space-x-2">
                       <input 
                        type="radio" 
                        name="comorbidCount" 
                        value={opt}
                        checked={formData.comorbidCount === opt}
                        onChange={(e) => handleInputChange('B', 'comorbidCount', e.target.value)}
                       />
                       <span>{opt}</span>
                     </label>
                   ))}
                 </div>
              </div>
            </section>

            {/* --- SECTION C: MEDICATION DETAILS --- */}
            <section className="bg-white p-6 rounded-lg shadow-sm border border-gray-200">
              <h2 className="text-xl font-bold text-blue-800 mb-4 border-b pb-2">SECTION C: Medication Details</h2>
              
              <div className="grid grid-cols-1 md:grid-cols-2 gap-6 mb-6">
                <div>
                  <label className="block text-sm font-semibold text-gray-600 mb-2">9. Total prescribed drugs</label>
                   <div className="flex gap-4">
                     {['2-4', '5-7', '≥8'].map(opt => (
                       <label key={opt} className="flex items-center space-x-2">
                         <input 
                          type="radio" 
                          name="totalDrugs" 
                          value={opt}
                          checked={formData.totalDrugs === opt}
                          onChange={(e) => handleInputChange('C', 'totalDrugs', e.target.value)}
                         />
                         <span>{opt}</span>
                       </label>
                     ))}
                   </div>
                </div>
                <div>
                  <label className="block text-sm font-semibold text-gray-600 mb-2">10. Antibiotics prescribed?</label>
                   <div className="flex gap-4">
                     {['Yes', 'No'].map(opt => (
                       <label key={opt} className="flex items-center space-x-2">
                         <input 
                          type="radio" 
                          name="antibiotics" 
                          value={opt}
                          checked={formData.antibioticsPrescribed === opt}
                          onChange={(e) => handleInputChange('C', 'antibioticsPrescribed', e.target.value)}
                         />
                         <span>{opt}</span>
                       </label>
                     ))}
                   </div>
                </div>
              </div>

              <div className="mb-2">
                <label className="block text-sm font-semibold text-gray-600 mb-2">11. List all prescribed drugs</label>
                <div className="space-y-2">
                  <div className="grid grid-cols-12 gap-2 text-xs font-bold text-gray-500 uppercase">
                    <div className="col-span-1 text-center">Sr</div>
                    <div className="col-span-5">Generic Name</div>
                    <div className="col-span-3">Dose</div>
                    <div className="col-span-2">Frequency</div>
                    <div className="col-span-1"></div>
                  </div>
                  
                  {formData.medications.map((med, idx) => (
                    <div key={idx} className="grid grid-cols-12 gap-2">
                      <div className="col-span-1 flex items-center justify-center text-gray-400 font-mono">
                        {idx + 1}
                      </div>
                      <div className="col-span-5">
                        <input 
                          type="text" 
                          placeholder="e.g. Warfarin"
                          className="w-full p-2 border border-gray-300 rounded text-sm"
                          value={med.name}
                          onChange={(e) => handleMedicationChange(idx, 'name', e.target.value)}
                        />
                      </div>
                      <div className="col-span-3">
                        <input 
                          type="text" 
                          placeholder="e.g. 5mg"
                          className="w-full p-2 border border-gray-300 rounded text-sm"
                          value={med.dose}
                          onChange={(e) => handleMedicationChange(idx, 'dose', e.target.value)}
                        />
                      </div>
                      <div className="col-span-2">
                        <input 
                          type="text" 
                          placeholder="e.g. OD"
                          className="w-full p-2 border border-gray-300 rounded text-sm"
                          value={med.frequency}
                          onChange={(e) => handleMedicationChange(idx, 'frequency', e.target.value)}
                        />
                      </div>
                      <div className="col-span-1 flex items-center justify-center">
                        <button onClick={() => removeMedicationRow(idx)} className="text-red-400 hover:text-red-600">
                          <i className="fas fa-times"></i>
                        </button>
                      </div>
                    </div>
                  ))}
                  
                  <button onClick={addMedicationRow} className="text-sm text-blue-600 hover:underline flex items-center gap-1 mt-2 font-semibold">
                    <i className="fas fa-plus"></i> Add another drug
                  </button>
                </div>
              </div>
            </section>

            {/* --- AI ANALYSIS TOOL --- */}
            <section className="bg-indigo-50 border-2 border-indigo-200 p-6 rounded-lg shadow-sm">
              <div className="flex items-center gap-2 mb-4">
                <div className="bg-indigo-600 text-white p-2 rounded-lg">
                  <i className="fas fa-heartbeat text-2xl"></i>
                </div>
                <div>
                  <h3 className="text-lg font-bold text-indigo-900">AI Interaction Checker</h3>
                  <p className="text-xs text-indigo-700">Powered by Google Gemini</p>
                </div>
              </div>

              <div className="flex flex-col md:flex-row gap-2 mb-4">
                <button 
                  onClick={analyzeInteractions}
                  disabled={loading}
                  className={`w-full py-3 rounded font-bold text-white flex items-center justify-center gap-2 shadow-lg transition-all ${loading ? 'bg-indigo-400' : 'bg-indigo-600 hover:bg-indigo-700 hover:scale-[1.02]'}`}
                >
                  {loading ? <i className="fas fa-spinner fa-spin"></i> : <i className="fas fa-search"></i>}
                  {loading ? 'Analyzing...' : 'Analyze Risks Now'}
                </button>
              </div>

              {error && (
                <div className="bg-red-100 text-red-700 p-3 rounded text-sm flex items-center gap-2">
                  <i className="fas fa-exclamation-circle"></i> {error}
                </div>
              )}

              {formData.interactionIdentified === 'Yes' && formData.aiDetailedExplanation && (
                <div className={`border p-6 mt-6 rounded-lg shadow-sm transition-all duration-500 ${getSeverityColorStyles(formData.interactionSeverity)}`}>
                  {/* Header with Severity Badge */}
                  <div className="flex justify-between items-start mb-4">
                    <h4 className="font-bold text-lg flex items-center gap-2">
                      <i className="fas fa-exclamation-triangle"></i>
                      Interaction Analysis
                    </h4>
                    {getSeverityBadge(formData.interactionSeverity)}
                  </div>

                  {/* Description */}
                  <p className="text-sm font-medium opacity-90 leading-relaxed mb-4 p-2 bg-white/50 rounded">
                    {formData.aiDetailedExplanation}
                  </p>

                  {/* Follow-up Questions */}
                  {formData.aiFollowUpQueries && formData.aiFollowUpQueries.length > 0 && (
                    <div className="bg-white/60 p-3 rounded-lg border border-white/40 mb-4">
                      <h5 className="font-bold text-sm mb-2 flex items-center gap-2">
                        <i className="fas fa-stethoscope"></i>
                        Recommended Checks / Questions:
                      </h5>
                      <ul className="list-disc list-inside space-y-1">
                        {formData.aiFollowUpQueries.map((query, i) => (
                          <li key={i} className="text-sm">{query}</li>
                        ))}
                      </ul>
                    </div>
                  )}

                  {/* NEW: Alternatives Section with Calculations */}
                  {formData.aiAlternatives && formData.aiAlternatives.length > 0 && (
                    <div className="mt-4 bg-green-50 border border-green-200 rounded-lg p-4">
                      <h5 className="font-bold text-sm text-green-800 mb-3 flex items-center gap-2">
                        <i className="fas fa-capsules"></i> Safer Therapeutic Alternatives
                      </h5>
                      <div className="space-y-3">
                        {formData.aiAlternatives.map((alt, idx) => (
                          <div key={idx} className="bg-white rounded shadow-sm border border-green-100 overflow-hidden">
                            {/* Alternative Header */}
                            <div className="bg-green-100 px-3 py-2 flex justify-between items-center border-b border-green-200">
                              <span className="font-bold text-green-900">{alt.drug}</span>
                              <span className="text-xs font-mono font-bold bg-white px-2 py-1 rounded text-green-700">{alt.dose} ({alt.frequency})</span>
                            </div>
                            
                            <div className="p-3 space-y-2">
                              {/* Reason */}
                              <div className="text-xs">
                                <span className="font-bold text-gray-700 block mb-1">Reason for Selection:</span>
                                <p className="text-gray-600">{alt.reason}</p>
                              </div>

                              {/* Logic/Formula */}
                              <div className="text-xs bg-gray-50 p-2 rounded border border-gray-100">
                                <span className="font-bold text-gray-700 block mb-1"><i className="fas fa-calculator text-blue-400"></i> Calculation & Logic:</span>
                                <p className="text-gray-600 mb-1">{alt.calculationBasis || 'Standard adult dosing applied based on patient profile.'}</p>
                                {alt.formulaUsed && (
                                  <div className="font-mono text-gray-500 text-[10px] mt-1 pt-1 border-t border-gray-200">
                                    Formula: {alt.formulaUsed}
                                  </div>
                                )}
                              </div>

                              {/* Action */}
                              <div className="text-xs text-blue-700 bg-blue-50 p-2 rounded flex items-start gap-2">
                                <i className="fas fa-info-circle mt-0.5"></i>
                                <div>
                                  <span className="font-bold">Action Required:</span> {alt.callToAction || 'Monitor clinical response.'}
                                </div>
                              </div>
                            </div>
                          </div>
                        ))}
                      </div>
                    </div>
                  )}
                </div>
              )}
            </section>

            {/* --- SECTION D: INTERACTION ID --- */}
            <section className="bg-white p-6 rounded-lg shadow-sm border border-gray-200 relative">
               {loading && <div className="absolute inset-0 bg-white/50 z-10 animate-pulse" />}
               
              <h2 className="text-xl font-bold text-blue-800 mb-4 border-b pb-2">SECTION D: Interaction Identification</h2>
              
              <div className="grid grid-cols-1 md:grid-cols-2 gap-6">
                <div>
                  <label className="block text-sm font-semibold text-gray-600 mb-2">12. Was interaction identified?</label>
                  <div className="flex gap-4">
                    {['Yes', 'No'].map(opt => (
                       <label key={opt} className="flex items-center space-x-2">
                         <input 
                          type="radio" 
                          name="interactionIdentified" 
                          value={opt}
                          checked={formData.interactionIdentified === opt}
                          onChange={(e) => handleInputChange('D', 'interactionIdentified', e.target.value)}
                         />
                         <span>{opt}</span>
                       </label>
                     ))}
                  </div>
                </div>

                {formData.interactionIdentified === 'Yes' && (
                  <>
                    <div>
                      <label className="block text-sm font-semibold text-gray-600 mb-2">13. Number of interactions</label>
                      <div className="flex gap-4">
                        {['1', '2-3', '>3'].map(opt => (
                          <label key={opt} className="flex items-center space-x-2">
                            <input 
                              type="radio" 
                              name="interactionCount" 
                              value={opt}
                              checked={formData.interactionCount === opt}
                              onChange={(e) => handleInputChange('D', 'interactionCount', e.target.value)}
                            />
                            <span>{opt}</span>
                          </label>
                        ))}
                      </div>
                    </div>

                    <div>
                      <label className="block text-sm font-semibold text-gray-600 mb-2">14. Type of interaction</label>
                      <div className="flex flex-col gap-1">
                        {['Pharmacokinetic', 'Pharmacodynamic', 'Both'].map(opt => (
                          <label key={opt} className="flex items-center space-x-2">
                            <input 
                              type="checkbox" 
                              checked={formData.interactionType.includes(opt)}
                              onChange={() => handleCheckboxGroup('interactionType', opt)}
                            />
                            <span>{opt}</span>
                          </label>
                        ))}
                      </div>
                    </div>

                    <div>
                      <label className="block text-sm font-semibold text-gray-600 mb-2">15. Severity</label>
                      <div className="flex gap-4">
                        {['Major', 'Moderate', 'Minor'].map(opt => (
                          <label key={opt} className="flex items-center space-x-2">
                            <input 
                              type="radio" 
                              name="severity" 
                              value={opt}
                              checked={formData.interactionSeverity === opt}
                              onChange={(e) => handleInputChange('D', 'interactionSeverity', e.target.value)}
                            />
                            <span className={
                              opt === 'Major' ? 'text-red-600 font-bold' : 
                              opt === 'Moderate' ? 'text-orange-600 font-bold' : 
                              'text-yellow-600 font-bold'
                            }>{opt}</span>
                          </label>
                        ))}
                      </div>
                    </div>

                    <div>
                      <label className="block text-sm font-semibold text-gray-600 mb-2">16. Onset</label>
                      <div className="flex gap-4">
                        {['Rapid', 'Delayed', 'Unknown'].map(opt => (
                          <label key={opt} className="flex items-center space-x-2">
                            <input 
                              type="radio" 
                              name="onset" 
                              value={opt}
                              checked={formData.interactionOnset === opt}
                              onChange={(e) => handleInputChange('D', 'interactionOnset', e.target.value)}
                            />
                            <span>{opt}</span>
                          </label>
                        ))}
                      </div>
                    </div>

                    <div className="md:col-span-2">
                      <label className="block text-sm font-semibold text-gray-600 mb-1">17. Drug combination involved</label>
                      <textarea 
                        className="w-full p-2 border border-gray-300 rounded focus:ring-2 focus:ring-blue-500 outline-none"
                        rows="2"
                        value={formData.drugCombination}
                        onChange={(e) => handleInputChange('D', 'drugCombination', e.target.value)}
                      />
                    </div>
                  </>
                )}
              </div>
            </section>

            {/* --- SECTION E: CLINICAL SIGNIFICANCE --- */}
            {formData.interactionIdentified === 'Yes' && (
              <section className="bg-white p-6 rounded-lg shadow-sm border border-gray-200">
                <h2 className="text-xl font-bold text-blue-800 mb-4 border-b pb-2">SECTION E: Clinical Significance</h2>
                
                <div className="mb-4">
                   <label className="block text-sm font-semibold text-gray-600 mb-2">18. Did interaction produce clinical effect?</label>
                   <div className="flex gap-4">
                    {['Yes', 'No'].map(opt => (
                       <label key={opt} className="flex items-center space-x-2">
                         <input 
                          type="radio" 
                          name="clinicalEffect" 
                          value={opt}
                          checked={formData.clinicalEffect === opt}
                          onChange={(e) => handleInputChange('E', 'clinicalEffect', e.target.value)}
                         />
                         <span>{opt}</span>
                       </label>
                     ))}
                   </div>
                </div>

                {formData.clinicalEffect === 'Yes' && (
                  <div className="mb-4">
                    <label className="block text-sm font-semibold text-gray-600 mb-2">19. If yes, what was observed?</label>
                    <div className="grid grid-cols-1 md:grid-cols-2 gap-2">
                      {['Adverse drug reaction', 'Abnormal laboratory value', 'Reduced therapeutic effect', 'Increased toxicity'].map(opt => (
                        <label key={opt} className="flex items-center space-x-2">
                          <input 
                            type="checkbox" 
                            checked={formData.clinicalObservations.includes(opt)}
                            onChange={() => handleCheckboxGroup('clinicalObservations', opt)}
                          />
                          <span>{opt}</span>
                        </label>
                      ))}
                    </div>
                  </div>
                )}
              </section>
            )}

            {/* --- SECTION F: MANAGEMENT --- */}
            <section className="bg-white p-6 rounded-lg shadow-sm border border-gray-200">
              <h2 className="text-xl font-bold text-blue-800 mb-4 border-b pb-2">SECTION F: Management & Intervention</h2>
              
              <div className="mb-4">
                 <label className="block text-sm font-semibold text-gray-600 mb-2">21. Was action taken?</label>
                 <div className="flex gap-4">
                  {['Yes', 'No'].map(opt => (
                     <label key={opt} className="flex items-center space-x-2">
                       <input 
                        type="radio" 
                        name="actionTaken" 
                        value={opt}
                        checked={formData.actionTaken === opt}
                        onChange={(e) => handleInputChange('F', 'actionTaken', e.target.value)}
                       />
                       <span>{opt}</span>
                     </label>
                   ))}
                 </div>
              </div>

              {formData.actionTaken === 'Yes' && (
                <div className="mb-4">
                  <label className="block text-sm font-semibold text-gray-600 mb-2">22. What action was taken?</label>
                  <div className="grid grid-cols-2 gap-2">
                    {['Dose adjustment', 'Drug discontinued', 'Drug replaced', 'Additional monitoring', 'No change'].map(opt => (
                      <label key={opt} className="flex items-center space-x-2">
                        <input 
                          type="checkbox" 
                          checked={formData.actionTakenType.includes(opt)}
                          onChange={() => handleCheckboxGroup('actionTakenType', opt)}
                        />
                        <span>{opt}</span>
                      </label>
                    ))}
                  </div>
                </div>
              )}
              
              <div>
                 <label className="block text-sm font-semibold text-gray-600 mb-2">23. Was a clinical pharmacist involved?</label>
                 <div className="flex gap-4">
                  {['Yes', 'No'].map(opt => (
                     <label key={opt} className="flex items-center space-x-2">
                       <input 
                        type="radio" 
                        name="pharmacistInvolved" 
                        value={opt}
                        checked={formData.pharmacistInvolved === opt}
                        onChange={(e) => handleInputChange('F', 'pharmacistInvolved', e.target.value)}
                       />
                       <span>{opt}</span>
                     </label>
                   ))}
                 </div>
              </div>
            </section>

            {/* --- SECTION G: OUTCOME --- */}
            <section className="bg-white p-6 rounded-lg shadow-sm border border-gray-200">
              <h2 className="text-xl font-bold text-blue-800 mb-4 border-b pb-2">SECTION G: Outcome Assessment</h2>
              
              <div className="grid grid-cols-1 md:grid-cols-2 gap-6">
                <div>
                  <label className="block text-sm font-semibold text-gray-600 mb-2">24. Did interaction affect hospital stay?</label>
                  <div className="flex gap-4">
                    {['Yes', 'No'].map(opt => (
                       <label key={opt} className="flex items-center space-x-2">
                         <input 
                          type="radio" 
                          name="hospitalStayAffected" 
                          value={opt}
                          checked={formData.hospitalStayAffected === opt}
                          onChange={(e) => handleInputChange('G', 'hospitalStayAffected', e.target.value)}
                         />
                         <span>{opt}</span>
                       </label>
                     ))}
                  </div>
                </div>

                <div>
                  <label className="block text-sm font-semibold text-gray-600 mb-1">25. Length of hospital stay (days)</label>
                  <input 
                    type="number" 
                    className="w-full p-2 border border-gray-300 rounded focus:ring-2 focus:ring-blue-500 outline-none"
                    value={formData.stayLength}
                    onChange={(e) => handleInputChange('G', 'stayLength', e.target.value)}
                  />
                </div>

                <div className="md:col-span-2">
                   <label className="block text-sm font-semibold text-gray-600 mb-2">26. Final patient outcome</label>
                   <div className="flex gap-4 flex-wrap">
                     {['Recovered', 'Improved', 'Referred', 'Deceased'].map(opt => (
                       <label key={opt} className="flex items-center space-x-2">
                         <input 
                          type="radio" 
                          name="finalOutcome" 
                          value={opt}
                          checked={formData.finalOutcome === opt}
                          onChange={(e) => handleInputChange('G', 'finalOutcome', e.target.value)}
                         />
                         <span>{opt}</span>
                       </label>
                     ))}
                   </div>
                </div>
              </div>
            </section>
            
            {/* Footer */}
            <div className="flex justify-center pt-6 pb-6">
              <button 
                onClick={saveToSupabase}
                disabled={saveStatus === 'saving' || saveStatus === 'success'}
                className={`${
                  saveStatus === 'success' ? 'bg-green-600 hover:bg-green-700' : 
                  saveStatus === 'error' ? 'bg-red-600 hover:bg-red-700' :
                  editingId ? 'bg-indigo-700 hover:bg-indigo-800' :
                  'bg-blue-800 hover:bg-blue-900'
                } text-white px-8 py-3 rounded-lg shadow-lg font-bold flex items-center gap-2 transition-all w-full md:w-auto justify-center`}
              >
                {saveStatus === 'saving' ? <i className="fas fa-spinner fa-spin"></i> : 
                 saveStatus === 'success' ? <i className="fas fa-check-circle"></i> : 
                 <i className="fas fa-save"></i>}
                
                {saveStatus === 'saving' ? 'Saving...' : 
                 saveStatus === 'success' ? 'Saved Successfully!' : 
                 editingId ? 'Update Record' : 'Save New Record'}
              </button>
            </div>

          </div>
        </div>
      );
    }

    const root = ReactDOM.createRoot(document.getElementById('root'));
    root.render(<App />);
  </script>
</body>
</html>
